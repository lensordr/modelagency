<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Business Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        @keyframes blink-orange {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“‹ Business Dashboard</h1>
        
        <!-- Trial Warning Banner -->
        <div id="trialBanner" class="trial-banner" style="display: none; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <div class="trial-content" style="display: flex; justify-content: space-between; align-items: center;">
                <span id="trialMessage"></span>
                <div class="trial-actions">
                    <a href="#" onclick="upgradeNow()" class="upgrade-btn" style="background: white; color: #d97706; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; margin-right: 0.5rem; font-weight: 600;">Upgrade Now</a>
                    <button onclick="dismissTrial()" class="dismiss-btn" style="background: transparent; color: white; border: 1px solid white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Dismiss</button>
                </div>
            </div>
        </div>
        
        <nav class="dashboard-nav">
            <button onclick="showSection('live-orders')" class="nav-btn active" id="live-orders-btn">ğŸ”´ Live Orders</button>
            <button onclick="openBarOrdersPopup()" class="nav-btn" id="bar-orders-popup-btn">ğŸº Bar Orders</button>
            <button onclick="openKitchen()" class="nav-btn" id="kitchen-btn">ğŸ‘¨ğŸ³ Kitchen</button>
            <button onclick="showSection('waiters-new')" class="nav-btn" id="waiters-new-btn">ğŸ‘¨ğŸ³ Waiters</button>
            <button onclick="showSection('analytics')" class="nav-btn" id="analytics-btn">ğŸ“Š Analytics</button>
            <button onclick="showSection('menu-management')" class="nav-btn" id="menu-management-btn">ğŸ½ï¸ Menu</button>
            <button onclick="showSection('qr-codes')" class="nav-btn" id="qr-codes-btn">ğŸ“± QR Codes</button>
            <button onclick="logout()" class="nav-btn logout-btn" style="margin-left: auto; background: #e53e3e;">ğŸšª Logout</button>
        </nav>

        <div id="live-orders" class="section-content">
            <div class="dashboard-section">
            <h2 id="tables-overview-title">ğŸ½ Tables Overview</h2>
            <p style="color: #718096; margin-bottom: 1.5rem;" id="tables-overview-desc">Click on occupied tables to view order details</p>
            <div id="tables-grid"></div>
            </div>
            
            <div id="order-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2 id="order-modal-title">ğŸ“‹ Order Details - Table <span id="modal-table-number"></span></h2>
                    <div id="order-details"></div>
                    <div class="waiter-selection">
                        <label for="waiter-select">Select Waiter:</label>
                        <select id="waiter-select" required>
                            <option value="">Choose waiter...</option>
                        </select>
                    </div>
                    <div class="modal-buttons">
                        <button id="cancel-order-btn" onclick="cancelOrder()" style="background: #e53e3e !important; color: white !important; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin-right: 10px;">Cancel Order</button>
                        <button id="split-bill-btn" onclick="showSplitBillModal()" style="background: #f59e0b !important; color: white !important; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin-right: 10px;">Split Bill</button>
                        <button id="checkout-table-btn" class="checkout-btn">Checkout Table</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Split Bill Modal -->
        <div id="split-bill-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeSplitBillModal()">&times;</span>
                <h2 id="split-modal-title">ğŸ’° Split Bill - Table <span id="split-modal-table-number"></span></h2>
                <p style="color: #666; margin-bottom: 20px;">Select items to checkout separately. Remaining items will stay active for other customers.</p>
                <div id="split-order-details"></div>
                <div class="waiter-selection" style="margin: 20px 0;">
                    <label for="split-waiter-select">Select Waiter:</label>
                    <select id="split-waiter-select" required>
                        <option value="">Choose waiter...</option>
                    </select>
                </div>
                <div class="tip-section" style="margin: 20px 0;">
                    <label for="split-tip-amount">Tip Amount (â‚¬):</label>
                    <input type="number" id="split-tip-amount" step="0.01" min="0" value="0" style="width: 100px; padding: 5px; margin-left: 10px;">
                </div>
                <div class="modal-buttons">
                    <button onclick="closeSplitBillModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Cancel</button>
                    <button id="process-split-btn" onclick="processSplitBill()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Process Split Checkout</button>
                </div>
            </div>
        </div>

        <div id="waiters-new" class="section-content" style="display: none;">
            <div class="dashboard-section">
                <h2>ğŸ‘¨ğŸ³ Waiter Management</h2>
                
                <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #68d391;">
                    <h3>Add New Waiter</h3>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <input type="text" id="waiter-input" placeholder="Enter waiter name" style="flex: 1; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        <button onclick="addWaiter()" style="background: #38a169; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">Add</button>
                    </div>
                </div>
                
                <div>
                    <h3>Current Waiters</h3>
                    <div id="waiters-container" style="display: flex; flex-direction: column; gap: 10px;"></div>
                </div>
            </div>
        </div>

        <div id="analytics" class="section-content" style="display: none;">
            <div class="dashboard-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>ğŸ“Š Sales Analytics</h2>
                    <a href="javascript:void(0)" onclick="window.open(window.location.pathname.includes('/r/') ? window.location.pathname.replace('/business/dashboard', '/business/analytics') : '/business/analytics', '_blank')" style="background: #007bff; color: white; text-decoration: none; padding: 0.3rem 0.8rem; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">ğŸ“ˆ Advanced</a>
                </div>
            <div class="sales-controls">
                <div class="period-selector">
                    <button onclick="loadSales('day')" class="period-btn active" id="day-btn">Today</button>
                    <button onclick="loadSales('week')" class="period-btn" id="week-btn">This Week</button>
                    <button onclick="loadSales('month')" class="period-btn" id="month-btn">This Month</button>
                    <button onclick="loadSales('year')" class="period-btn" id="year-btn">This Year</button>
                </div>
            </div>
                <div id="sales-summary"></div>

            </div>
        </div>

        <div id="menu-management" class="section-content" style="display: none;">
            <div class="dashboard-section">
            <h2>ğŸ½ï¸ Menu Management</h2>
            <div class="menu-controls">
                <div class="upload-section">
                    <h3>ğŸ“„ Upload Menu</h3>
                    <form id="upload-form" enctype="multipart/form-data">
                        <div style="margin-bottom: 15px;">
                            <label for="menu-language" style="display: block; margin-bottom: 5px; font-weight: 600;">Select Language:</label>
                            <select id="menu-language" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                                <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                                <option value="es">ğŸ‡ªğŸ‡¸ Spanish</option>
                                <option value="fr">ğŸ‡«ğŸ‡· French</option>
                                <option value="de">ğŸ‡©ğŸ‡ª German</option>
                                <option value="it">ğŸ‡®ğŸ‡¹ Italian</option>
                            </select>
                        </div>
                        <input type="file" id="menu-file" accept=".xlsx,.xls,.pdf" required>
                        <button type="submit">Upload Menu</button>
                    </form>
                </div>
                
                <div class="menu-items-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>ğŸ´ Menu Items</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="menu-search" placeholder="Search menu items..." style="padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; width: 200px;" oninput="filterMenuItems()">
                            <select id="view-language" onchange="loadMenuItems()" style="padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px;">
                                <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                                <option value="es">ğŸ‡ªğŸ‡¸ Spanish</option>
                                <option value="fr">ğŸ‡«ğŸ‡· French</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="background: #f0fff4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #68d391;">
                        <h4>â• Add New Item</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <input type="text" id="new-item-name" placeholder="Item name" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="new-item-price" placeholder="Price" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="text" id="new-item-ingredients" placeholder="Ingredients" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="text" id="new-item-category" placeholder="Category" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="new-item-kitchen" checked style="transform: scale(1.2);">
                                <span>Needs Kitchen Preparation</span>
                            </label>
                        </div>
                        <button onclick="addMenuItem()" style="background: #38a169; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">Add Item</button>
                    </div>
                    
                    <div id="menu-items-list"></div>
                </div>
            </div>
        </div>

        <div id="qr-codes" class="section-content" style="display: none;">
            <div class="dashboard-section">
                <h2 id="qr-codes-title">ğŸ“± QR Codes for Tables</h2>
                <p style="color: #718096; margin-bottom: 1.5rem;" id="qr-codes-desc">Generate QR codes for each table. Customers can scan these to access the menu and place orders.</p>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button onclick="loadQRCodes()" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">ğŸ”„ Refresh QR Codes</button>
                    <button onclick="openQRCodesWindow()" style="background: #6f42c1; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">ğŸªŸ Open in New Window</button>
                    <button onclick="printAllQRCodes()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">ğŸ–¨ï¸ Print All</button>
                </div>
                
                <div id="qr-codes-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;"></div>
            </div>
        </div>

        <div id="instant-order" class="section-content" style="display: none;">
            <div class="dashboard-section">
                <h2>ğŸº Bar Instant Order</h2>
                
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <input type="text" id="instant-search" placeholder="Search menu items..." style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 10px;">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px;">
                    <div id="instant-menu-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;"></div>

                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 20px;">
                        <h3>Order Summary</h3>
                        <div id="instant-order-items">No items selected</div>
                        <div style="margin-top: 15px; font-weight: bold;">Total: â‚¬<span id="instant-total">0.00</span></div>
                        <button id="instant-checkout-btn" onclick="processInstantCheckout()" style="width: 100%; background: #28a745; color: white; border: none; padding: 15px; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px;" disabled>Instant Checkout</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="message"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        // Check trial status immediately
        setTimeout(function() {
            // Use current path structure for API calls
            const currentPath = window.location.pathname;
            const trialStatusUrl = currentPath.includes('/r/') 
                ? currentPath.replace('/business/dashboard', '/business/trial-status')
                : '/business/trial-status';
            
            fetch(trialStatusUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('Trial status:', data);
                    if (data.show_warning || data.expired) {
                        const banner = document.getElementById('trialBanner');
                        const message = document.getElementById('trialMessage');
                        
                        if (data.expired) {
                            message.textContent = 'ğŸš« Your free trial has expired. Please upgrade to continue using TableLink.';
                            banner.style.background = 'linear-gradient(135deg, #dc2626, #b91c1c)';
                        } else {
                            message.textContent = `â° Your free trial expires in ${data.days_left} day${data.days_left > 1 ? 's' : ''}!`;
                        }
                        
                        banner.style.display = 'block';
                    }
                })
                .catch(error => console.error('Trial status error:', error));
        }, 1000);
        
        function dismissTrial() {
            document.getElementById('trialBanner').style.display = 'none';
        }
        
        async function upgradeNow() {
            // Get current restaurant info and redirect to signup with pre-filled data
            const currentPath = window.location.pathname;
            if (currentPath.includes('/r/')) {
                const subdomain = currentPath.split('/r/')[1].split('/')[0];
                
                // Get restaurant details for pre-filling
                try {
                    const response = await fetch('/business/restaurant-info');
                    const data = await response.json();
                    const params = new URLSearchParams({
                        upgrade: 'true',
                        subdomain: subdomain,
                        email: data.admin_email || '',
                        restaurant_name: data.name || '',
                        username: data.admin_username || 'admin',
                        table_count: data.table_count || 10
                    });
                    window.location.href = `/signup?${params.toString()}`;
                } catch (error) {
                    // Fallback without pre-filled email
                    window.location.href = `/signup?upgrade=true&subdomain=${subdomain}`;
                }
            } else {
                window.location.href = '/signup?upgrade=true';
            }
        }
    </script>
    <script src="/static/business_no_auth.js?v=20"></script>
</body>
</html>